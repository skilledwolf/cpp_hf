name: ci-and-release

on:
  pull_request:
  push:
    branches: [ main ]
    tags: [ "v*" ]
  workflow_dispatch:

concurrency:
  group: ci-and-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================
  # Build & test on PR/push
  # =========================
  build-test:
    name: Build & Test (${{ matrix.os }} / py${{ matrix.python }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - { runner: ubuntu-latest, os: Linux, python: "3.10" }
          - { runner: ubuntu-latest, os: Linux, python: "3.11" }
          - { runner: ubuntu-latest, os: Linux, python: "3.12" }
          - { runner: macos-latest,  os: macOS, python: "3.10" }
          - { runner: macos-latest,  os: macOS, python: "3.11" }
          - { runner: macos-latest,  os: macOS, python: "3.12" }
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: pip

      - name: Install system deps
        env: { HOMEBREW_NO_AUTO_UPDATE: "1" }
        run: |
          if [ "${{ matrix.os }}" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends \
              libfftw3-dev cmake ninja-build pkg-config libboost-dev
          else
            brew install fftw cmake ninja libomp boost || true
          fi

      - name: Build wheel (scikit-build-core)
        run: |
          python -m pip install -U pip numpy scikit-build-core build
          python -m build -w \
            -C cmake.define.HF_USE_OPENMP=ON \
            -C cmake.define.HF_USE_FFTW_THREADS=ON

      - name: Smoke test
        env:
          DYLD_FALLBACK_LIBRARY_PATH: /opt/homebrew/lib:/usr/local/lib
        run: |
          python -m pip install dist/*.whl
          python - <<'PY'
          import numpy as np, cpp_hf
          nk,d=8,2
          w=np.ones((nk,nk))*((2/nk)*(2/nk)/(2*np.pi)**2)
          H=np.zeros((nk,nk,d,d),np.complex128)
          K=np.linspace(-1,1,nk)
          V=(1.0/np.sqrt((K[:,None]**2+K[None,:]**2)+0.2)).astype(np.complex128)[...,None,None]
          P0=np.zeros_like(H); ne=0.5*d*w.sum()
          P,F,E,mu,n=cpp_hf.hartreefock_iteration_cpp(w,H,V,P0,ne,0.2,1,1e-2,2,1.0)
          print("wheel ok", int(n), float(mu))
          PY

      - name: Upload test wheels (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ci-wheels-${{ matrix.os }}-py${{ matrix.python }}
          path: dist/*.whl
          if-no-files-found: warn

  # ==========================================
  # Release wheels (cibuildwheel) — tags only
  # ==========================================
  wheels:
    name: Wheels (${{ matrix.name }})
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.runner }}
    permissions: { contents: read }
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            runner: ubuntu-latest
            cibw-archs: x86_64
          - name: linux-aarch64
            runner: ubuntu-24.04-arm
            cibw-archs: aarch64
          - name: macos-intel
            runner: macos-15-intel
            macos-deploy: "11.0"
          - name: macos-arm
            runner: macos-15
            macos-deploy: "11.0"

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # macOS preparation
      - name: macOS toolchain (Intel)
        if: matrix.name == 'macos-intel'
        env: { HOMEBREW_NO_AUTO_UPDATE: "1" }
        run: brew install fftw libomp boost cmake ninja || true

      - name: macOS toolchain + FFTW from source (ARM)
        if: matrix.name == 'macos-arm'
        env: { HOMEBREW_NO_AUTO_UPDATE: "1" }
        run: |
          set -eux
          brew install libomp boost cmake ninja || true
          # Your existing script that builds optimized FFTW into ~/.local
          bash ./build_fftw_macos_arm.sh
          {
            echo "PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig:$PKG_CONFIG_PATH"
            echo "CMAKE_PREFIX_PATH=$HOME/.local:$CMAKE_PREFIX_PATH"
            echo "LIBRARY_PATH=$HOME/.local/lib:$HOME/.local/lib64:$LIBRARY_PATH"
            echo "CPATH=$HOME/.local/include:$CPATH"
          } >> "$GITHUB_ENV"

      - name: Build wheels with cibuildwheel
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_BUILD: "cp310-* cp311-* cp312-*"
          CIBW_SKIP: "pp* *-musllinux_*"
          # Linux images & arches
          CIBW_ARCHS_LINUX: ${{ matrix.cibw-archs }}
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          # macOS targeting
          CIBW_ARCHS_MACOS: native
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.macos-deploy }}
          # Install build tools + FFTW/Boost inside manylinux container
          CIBW_BEFORE_ALL_LINUX: |
            set -eux
            if command -v dnf >/dev/null 2>&1; then PM=dnf; elif command -v yum >/dev/null 2>&1; then PM=yum; else PM=microdnf; fi
            $PM -y install pkgconfig ninja-build unzip make which curl ca-certificates xz tar gzip cmake gcc-c++ \
              fftw fftw-devel boost-devel zstd libzstd-devel || true
          # CMake flags for both platforms
          CIBW_ENVIRONMENT_LINUX: >
            CC=gcc CXX=g++
            CMAKE_ARGS="-G Ninja -DHF_USE_OPENMP=ON -DHF_USE_FFTW_THREADS=ON"
          CIBW_ENVIRONMENT_MACOS: >
            PKG_CONFIG_PATH=$PKG_CONFIG_PATH
            CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH
            LIBRARY_PATH=$LIBRARY_PATH
            CPATH=$CPATH
            CMAKE_ARGS="-DHF_USE_OPENMP=ON -DHF_USE_FFTW_THREADS=ON -DCMAKE_OSX_DEPLOYMENT_TARGET=${MACOSX_DEPLOYMENT_TARGET}"
          # Ensure delocate sees user-local FFTW on macOS
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
            bash -lc 'delocate-listdeps -d {wheel} || true; delocate-wheel -L $HOME/.local/lib -L /opt/homebrew/lib -L /usr/local/lib --require-archs {delocate_archs} -w {dest_dir} -v {wheel}'
          # Quick import test (same everywhere)
          CIBW_TEST_REQUIRES: numpy
          CIBW_TEST_COMMAND: |
            python - <<'PY'
            import numpy as np, cpp_hf
            nk,d=4,2
            w=np.ones((nk,nk))*((2/nk)*(2/nk)/(2*np.pi)**2)
            H=np.zeros((nk,nk,d,d),np.complex128)
            K=np.linspace(-1,1,nk)
            V=(1.0/np.sqrt((K[:,None]**2+K[None,:]**2)+0.2)).astype(np.complex128)[...,None,None]
            P0=np.zeros_like(H); ne=0.5*d*w.sum()
            P,F,E,mu,n=cpp_hf.hartreefock_iteration_cpp(w,H,V,P0,ne,0.2,1,1e-2,2,1.0)
            print("wheel ok", int(n), float(mu))
            PY

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: dist-wheels-${{ matrix.name }}
          path: wheelhouse/*
          if-no-files-found: error

  # ==========================
  # Source dist — tags only
  # ==========================
  sdist:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions: { contents: read }
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip build
      - run: python -m build -s
      - uses: actions/upload-artifact@v4
        with:
          name: dist-sdist
          path: dist/*
          if-no-files-found: error

  # ==========================
  # Publish — tags only
  # ==========================
  publish:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-test, wheels, sdist]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist
      - name: Publish to PyPI (Trusted Publisher)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/